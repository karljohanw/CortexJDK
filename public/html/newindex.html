<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contig viewer</title>
    <link rel="stylesheet" href="indiana.css" />
    <script src="d3.v3.min.js" charset="utf-8"></script>
</head>

<body>

<article>

<section id="datasets">
    <select id="selectCross"></select>
    <select id="selectSample"></select>
    <select id="selectAccession"></select>
    <select id="selectGraph"></select>
    <input type="search" id="searchContigs">
    <span id="status"></span>
</section>

<section id="columns">
    <section id="circos"></section>
    <section id="annotations"></section>
</section>

<section id="viewer">
</section>

<script type="text/javascript">
    function loadCircosPlot(xml) {
        var circosSvg = xml.getElementsByTagName("svg")[0];
        var size = window.innerWidth < window.innerHeight ? 0.7*window.innerWidth : 0.7*window.innerHeight;

        d3.select("#circos").selectAll("svg").remove();

        d3.select("#circos").node().appendChild(circosSvg);

        d3.select("#circos").select("svg")
                .attr("width", size)
                .attr("height", size)
                .attr("viewBox", "0 0 3000 3000")

        d3.select("#recomb").selectAll("path")
                .attr("class", "contigLineUnselected")
    }

    function showContig() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        var sampleIndex = d3.select("#selectSample").property("selectedIndex");
        var sampleValue = d3.select("#selectSample").selectAll("option")[0][sampleIndex].__data__;

        var accessionIndex = d3.select("#selectAccession").property("selectedIndex");
        var accessionValue = d3.select("#selectAccession").selectAll("option")[0][accessionIndex].__data__;

        var graphIndex = d3.select("#selectGraph").property("selectedIndex");
        var graphValue = d3.select("#selectGraph").selectAll("option")[0][graphIndex].__data__;

        k = (graphValue.kmerSize == "all") ? 0 : parseInt(graphValue.kmerSize.replace("k", ""));

        d3.json("linearcontig?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue + "&contigName=" + contigName + "&kmerSize=" + graphValue.kmerSize + "&graphLabel=" + graphValue.label, function(json) {
            d3.select("#status").text("Displaying contig...");

            var width  = window.innerWidth,
                height = 500;

            d3.select("#viewer").selectAll("svg").remove();

            var svg = d3.select("#viewer").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .call(d3.behavior.zoom().on("zoom", zoom))
                    .append("g")

            for (d in d3.values(json.bases)) {
                basesMap = json.bases[d];

                for (ei in basesMap) {
                    e = basesMap[ei];
                    e.pos = parseInt(e.pos);

                    var inCount = 0, outCount = 0;
                    var yPos = height/2;
                    if (e.type == "inedge")  { yPos = (height/2) + 3*(inCount  + 1); inCount++;  }
                    if (e.type == "outedge") { yPos = (height/2) - 3*(outCount + 1); outCount++; }

                    var bgcolor = "#ffffff";
                    if (e.annotation == "0") { bgcolor = "#e94b35"; }
                    else if (e.annotation == "1") { bgcolor = "#9cf1ff"; }
                    else if (e.annotation == "_") { bgcolor = "#63a69f"; }
                    else if (e.annotation == "B") { bgcolor = "#f2e1ac"; }
                    else if (e.annotation == ".") { bgcolor = "#f2836b"; }
                    else if (e.annotation == "R") { bgcolor = "#f2594b"; }
                    else if (e.annotation == "M") { bgcolor = "#cd2c24"; }

                    svg.append("svg:rect")
                            .attr("x", e.pos - 1)
                            .attr("y", yPos - 1)
                            .attr("width", 1)
                            .attr("height", 1)
                            .attr("fill", bgcolor)
                            .attr("fill-opacity", 0.3)

                    svg.append("text")
                            .attr("class", e.class)
                            .attr("id", e.id)
                            .attr("text-anchor", "end")
                            .attr("x", e.pos)
                            .attr("y", yPos)
                            .text(e.base)
                            .on("mouseover", function(a) {
                                if (k != 0) {
                                    svg.append("rect")
                                            .attr("class", "kmercursor")
                                            .attr("width", k)
                                            .attr("height", 0.10)
                                            .attr("x", parseInt(d3.select(this).attr("x")) - 1)
                                            .attr("y", (height / 2) + 0.5)
                                }
                            })
                            .on("mouseout", function(a) {
                                d3.selectAll(".kmercursor").remove();
                            })

                    if (e.type == "outedge") {
                        svg.append("line")
                                .attr("class", "link")
                                .attr("x1", e.pos - 1 - 0.2)
                                .attr("y1", (height / 2) - 0.5)
                                .attr("x2", e.pos - 0.5)
                                .attr("y2", yPos)
                    } else if (e.type == "inedge") {
                        svg.append("line")
                                .attr("class", "link")
                                .attr("x1", e.pos + 1 - 0.2)
                                .attr("y1", (height / 2) - 0.5)
                                .attr("x2", e.pos - 0.5)
                                .attr("y2", yPos)
                    }


                }
            }

            function zoom() {
                svg.attr("transform",
                                "translate(" + d3.event.translate + ")" +
                                "scale(" + d3.event.scale + ")");
            }

            displayedContig = contigName;

            d3.select("#status").text("Ready.");
        });
    }

    function changeAccession() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        var sampleIndex = d3.select("#selectSample").property("selectedIndex");
        var sampleValue = d3.select("#selectSample").selectAll("option")[0][sampleIndex].__data__;

        var accessionIndex = d3.select("#selectAccession").property("selectedIndex");
        var accessionValue = d3.select("#selectAccession").selectAll("option")[0][accessionIndex].__data__;

        d3.json("graphs?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue, function(json) {
            d3.select("#selectGraph").selectAll("option").remove();

            d3.select("#selectGraph")
                    .selectAll("option")
                    .data(json.entries)
                    .enter()
                    .append("option")
                    .text(function(d) { return d.kmerSize + ": " + d.label; });

            d3.select("#selectGraph")
                    .on("change", showContig);
        });

        d3.xml("circos?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue)
                .on("progress", function() {
                    d3.select("#status").text("Loading Circos plot...");
                })
                .on("load", function(xml) {
                    loadCircosPlot(xml);

                    d3.select("#status").text("Ready.");
                })
                .get();

        d3.json("numcontigs?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue, function(data) {
            d3.select("#status").text("Loading contigs...");

            d3.select("#searchContigs")
                    .attr("placeholder", data.numContigs + " contigs loaded.  Select with JEXL expressions.")
                    .on("keyup", function() {
                        if (d3.event.keyCode == 13) {
                            var jexl = encodeURIComponent(d3.select("#searchContigs").property("value"));

                            d3.xml("search?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue + "&jexl=" + jexl)
                                    .on("progress", function() {
                                        d3.select("#status").text("Searching...");
                                    })
                                    .on("load", function(xml) {
                                        loadCircosPlot(xml);

                                        var contigLines = d3.select("#circos").select("svg").select("#recomb").selectAll("path");
                                        var numResults = contigLines.size();

                                        contigLines
                                                .on("mouseover", function(d) {
                                                    var id = d3.select(this).attr("id");
                                                    var color = d3.select(this).style("stroke");

                                                    d3.select(this).attr("class", "contigLineSelected")

                                                    d3.select("#circos").select("svg")
                                                            .append("text")
                                                            .attr("x", d3.mouse(this)[0] + 10)
                                                            .attr("y", d3.mouse(this)[1] - 10)
                                                            .attr("id", "tooltip")
                                                            .text(id)
                                                            .attr("font-family", "sans-serif")
                                                            .attr("font-size", "40px")
                                                            .attr("fill", color);
                                                })
                                                .on("mouseout", function(d) {
                                                    d3.select(this).attr("class", "contigLineUnselected")

                                                    d3.selectAll("#tooltip").remove();
                                                })
                                                .on("click", function(d) {
                                                    contigName = d3.select(this).attr("id");

                                                    d3.json("info?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue + "&contigName=" + contigName)
                                                            .on("progress", function() {
                                                                d3.select("#status").text("Drawing contig...");
                                                            })
                                                            .on("load", function(json) {
                                                                var keys = [ 'contigName', 'baseLength', 'kmerLength', 'ref0', 'ref1', 'refAmb', 'refBoth', 'refNovel', 'refRep', 'refMissing', 'lrun0', 'lrun1', 'lrunAmb', 'lrunBoth', 'lrunNovel', 'lrunRep', 'lrunMissing', 'numSwitches', 'isReaped', 'canonicalLocus', 'ref0Locus', 'ref1Locus', 'ref0ToCanonicalBlock', 'ref1ToCanonicalBlock', 'ref0ToCanonicalExact', 'ref1ToCanonicalExact', 'sameChromosome', 'sameEffectiveLocus', 'genesRef0', 'genesRef1', 'alignedToCanonical', 'clippedInCanonical', 'numAlignmentsInCanonical', 'perfectAlignmentInCanonical', 'alignedToRef0', 'clippedInRef0', 'numAlignmentsInRef0', 'perfectAlignmentInRef0', 'alignedToRef1', 'clippedInRef1', 'numAlignmentsInRef1', 'perfectAlignmentInRef1' ];

                                                                d3.select("#annotations").selectAll("table").remove();
                                                                var table = d3.select("#annotations").append("table");

                                                                keys.map(function(key) {
                                                                    var row = table.append("tr");

                                                                    var bgcolor = "#ffffff";
                                                                    if (key == "ref0") { bgcolor = "#e94b35"; }
                                                                    else if (key == "ref1") { bgcolor = "#9cf1ff"; }
                                                                    else if (key == "refAmb") { bgcolor = "#63a69f"; }
                                                                    else if (key == "refBoth") { bgcolor = "#f2e1ac"; }
                                                                    else if (key == "refNovel") { bgcolor = "#f2836b"; }
                                                                    else if (key == "refRep") { bgcolor = "#f2594b"; }
                                                                    else if (key == "refMissing") { bgcolor = "#cd2c24"; }

                                                                    row.append("td").style("background-color", bgcolor).html(key);
                                                                    row.append("td").html(json.info[key]);
                                                                });

                                                                d3.select("#status").text("Ready.");
                                                            })
                                                            .get();

                                                    showContig();
                                                })

                                        d3.select("#status").text("Found " + numResults + " contigs.");
                                    })
                                    .get();
                        }
                    })

            d3.select("#status").text("Ready.");
        });
    }

    function changeSample() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        var sampleIndex = d3.select("#selectSample").property("selectedIndex");
        var sampleValue = d3.select("#selectSample").selectAll("option")[0][sampleIndex].__data__;

        d3.json("accessions?cross=" + crossValue + "&sample=" + sampleValue, function(data) {
            d3.select("#status").text("Loading accessions...");

            d3.select("#selectAccession").selectAll("option").remove();

            d3.select("#selectAccession")
                    .on("change", changeAccession)
                    .selectAll("option")
                    .data(data.accessions)
                    .enter()
                    .append("option")
                    .text(function(d) { return d; });

            changeAccession();

            d3.select("#status").text("Ready.");
        });
    }

    function changeCross() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        d3.json("samples?cross=" + crossValue, function(data) {
            d3.select("#status").text("Loading samples...");

            d3.select("#selectSample").selectAll("option").remove();

            d3.select("#selectSample")
                    .on("change", changeSample)
                    .selectAll("option")
                    .data(data.samples)
                    .enter()
                    .append("option")
                    .text(function(d) { return d; });

            changeSample();

            d3.select("#status").text("Ready.");
        });
    }

    d3.json("crosses", function(data) {
        d3.select("#status").text("Loading crosses...");

        d3.select("#selectCross")
                .on("change", changeCross)
                .selectAll("option")
                .data(data.crosses)
                .enter()
                .append("option")
                .text(function(d) { return d; })

        changeCross();

        d3.select("#status").text("Ready.");
    });
</script>

</article>

</body>

</html>