<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contig viewer</title>
    <link rel="stylesheet" href="indiana.css" />
    <script src="d3.v3.min.js" charset="utf-8"></script>
</head>

<body>

<article>

<section id="datasets">
    <select id="selectCross"></select>
    <select id="selectSample"></select>
    <select id="selectAccession"></select>
    <input type="search" id="searchContigs">
</section>

<section id="columns">
    <section id="circos"></section>
    <section id="annotations"></section>
</section>

<section id="viewer"></section>

<script type="text/javascript">
    function loadCircosPlot(xml) {
        var circosSvg = xml.getElementsByTagName("svg")[0];
        var size = window.innerWidth < window.innerHeight ? 0.7*window.innerWidth : 0.7*window.innerHeight;

        d3.select("#circos").selectAll("svg").remove();

        d3.select("#circos").node().appendChild(circosSvg);

        d3.select("#circos").select("svg")
                .attr("width", size)
                .attr("height", size)
                .attr("viewBox", "0 0 3000 3000")

        d3.select("#recomb").selectAll("path")
                .attr("class", "contigLineUnselected")
    }

    function changeAccession() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        var sampleIndex = d3.select("#selectSample").property("selectedIndex");
        var sampleValue = d3.select("#selectSample").selectAll("option")[0][sampleIndex].__data__;

        var accessionIndex = d3.select("#selectAccession").property("selectedIndex");
        var accessionValue = d3.select("#selectAccession").selectAll("option")[0][accessionIndex].__data__;

        d3.xml("circos?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue, function(xml) {
            loadCircosPlot(xml);
        });

        d3.json("numcontigs?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue, function(data) {
            d3.select("#searchContigs")
                    .attr("placeholder", data.numContigs + " contigs loaded.  Select with JEXL expressions.")
                    .on("keyup", function() {
                        if (d3.event.keyCode == 13) {
                            var jexl = encodeURIComponent(d3.select("#searchContigs").property("value"));

                            d3.xml("search?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue + "&jexl=" + jexl, function(xml) {
                                loadCircosPlot(xml);

                                var contigLines = d3.select("#circos").select("svg").select("#recomb").selectAll("path");
                                var numResults = contigLines.size();

                                contigLines
                                        .on("mouseover", function(d) {
                                            var id = d3.select(this).attr("id");
                                            var color = d3.select(this).style("stroke");

                                            d3.select(this).attr("class", "contigLineSelected")

                                            d3.select("#circos").select("svg")
                                                    .append("text")
                                                    .attr("x", d3.mouse(this)[0] + 10)
                                                    .attr("y", d3.mouse(this)[1] - 10)
                                                    .attr("id", "tooltip")
                                                    .text(id)
                                                    .attr("font-family", "sans-serif")
                                                    .attr("font-size", "40px")
                                                    .attr("fill", color);
                                        })
                                        .on("mouseout", function(d) {
                                            d3.select(this).attr("class", "contigLineUnselected")

                                            d3.selectAll("#tooltip").remove();
                                        })
                                        .on("click", function(d) {
                                            var id = d3.select(this).attr("id");

                                            d3.json("info?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue + "&contigName=" + id, function(json) {
                                                d3.select("#annotations").selectAll("p").remove();

                                                d3.select("#annotations").selectAll("p")
                                                        .data(d3.entries(json.info))
                                                        .enter()
                                                        .append("p")
                                                        .text(function(d) { return d.key + " : " + d.value; })
                                            })

                                            d3.json("contig?cross=" + crossValue + "&sample=" + sampleValue + "&accession=" + accessionValue + "&contigName=" + id, function(json) {
                                                d3.select("#viewer").selectAll("svg").remove();

                                                var data = json.seq;

                                                var dataMap = data.reduce(function(map, node) {
                                                    map[node.name] = node;
                                                    return map;
                                                }, {});

                                                var treeData = [];
                                                data.forEach(function(node) {
                                                    var parent = dataMap[node.parent];
                                                    if (parent) {
                                                        (parent.children || (parent.children = []))
                                                                .push(node);
                                                    } else {
                                                        treeData.push(node);
                                                    }
                                                });

                                                var width  = window.innerWidth,
                                                    height = 500;

                                                var tree = d3.layout.tree().size([height, width]);

                                                var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x]; });

                                                var svg = d3.select("#viewer").append("svg")
                                                        .attr("width", width)
                                                        .attr("height", height)
                                                        .append("g")
                                                        .call(d3.behavior.zoom().on("zoom", zoom))
                                                        .append("g")

                                                svg.append("svg:rect")
                                                        .attr("width", width)
                                                        .attr("height", height)
                                                        .attr("fill", "white");

                                                root = treeData[0];

                                                var i = 0;
                                                update(root);

                                                function update(source) {
                                                    var nodes = tree.nodes(root).reverse(),
                                                        links = tree.links(nodes);

                                                    nodes.forEach(function(d) {d.y = d.depth * 10; });

                                                    var node = svg.selectAll("g.node")
                                                            .data(nodes, function(d) { return d.id || (d.id = ++i); });

                                                    var nodeEnter = node.enter().append("g")
                                                            .attr("class", "node")
                                                            .attr("transform", function(d) {
                                                                return "translate(" + d.y + "," + d.x + ")";
                                                            });

                                                    nodeEnter.append("text")
                                                            .attr("x", function(d) {
                                                                return d.children || d._children ? -4 : 4;
                                                            })
                                                            .attr("dy", ".35em")
                                                            .attr("text-anchor", function(d) {
                                                                return d.children || d._children ? -4 : 4;
                                                            })
                                                            .text(function(d) { return d.base; })
                                                            .attr("title", function(d) { return d.name; })
                                                            .style("fill-opacity", 1);

                                                    var link = svg.selectAll("path.link")
                                                            .data(links, function(d) { return d.target.id; });

                                                    link.enter().insert("path", "g")
                                                            .attr("class", "link")
                                                            .attr("d", diagonal);
                                                }

                                                function zoom() {
                                                    svg.attr("transform",
                                                                    "translate(" + d3.event.translate + ")" +
                                                                        "scale(" + d3.event.scale + ")");
                                                }
                                            })
                                        })
                            });
                        }
                    })
        });
    }

    function changeSample() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        var sampleIndex = d3.select("#selectSample").property("selectedIndex");
        var sampleValue = d3.select("#selectSample").selectAll("option")[0][sampleIndex].__data__;

        d3.json("accessions?cross=" + crossValue + "&sample=" + sampleValue, function(data) {
            d3.select("#selectAccession").selectAll("option").remove();

            d3.select("#selectAccession")
                    .on("change", changeAccession)
                    .selectAll("option")
                    .data(data.accessions)
                    .enter()
                    .append("option")
                    .text(function(d) { return d; });

            changeAccession();
        });
    }

    function changeCross() {
        var crossIndex = d3.select("#selectCross").property("selectedIndex");
        var crossValue = d3.select("#selectCross").selectAll("option")[0][crossIndex].__data__;

        d3.json("samples?cross=" + crossValue, function(data) {
            d3.select("#selectSample").selectAll("option").remove();

            d3.select("#selectSample")
                    .on("change", changeSample)
                    .selectAll("option")
                    .data(data.samples)
                    .enter()
                    .append("option")
                    .text(function(d) { return d; });

            changeSample();
        });
    }

    d3.json("crosses", function(data) {
        d3.select("#selectCross")
                .on("change", changeCross)
                .selectAll("option")
                .data(data.crosses)
                .enter()
                .append("option")
                .text(function(d) { return d; })

        changeCross();
    });
</script>

</article>

</body>

</html>