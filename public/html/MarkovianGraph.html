<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contig viewer</title>
    <link rel="stylesheet" href="indiana.css"/>
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <style>
        path.link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5px;
        }

        path.link.twofive {
            opacity: 0.25;
        }

        path.link.fivezero {
            opacity: 0.50;
        }

        path.link.sevenfive {
            opacity: 0.75;
        }

        path.link.onezerozero {
            opacity: 1.0;
        }

        circle {
            fill: #ccc;
            stroke: #fff;
            stroke-width: 1.5px;
        }

        text {
            fill: #000;
            font: 10px sans-serif;
            pointer-events: none;
        }
    </style>
</head>

<body>

<article>
<h1>Markovian Graph</h1>

<section>
    <input type="search" id="search" placeholder="Enter name of contig" style="width: 500px">
</section>

<section id="viewer"></section>

</article>

</body>

<script type="text/javascript">
d3.select("#search")
    .on("keyup", function() {
            if (d3.event.keyCode == 13) {
                var contigName = encodeURIComponent(d3.select("#search").property("value"));

                var width = innerWidth,
                        height = innerHeight,
                        color = d3.scale.category20c();

                d3.select("body").selectAll("svg").remove();

                d3.json("/search?contigName=" + contigName, function(graph) {
                    contig = graph.contig;
                    links = graph.links;

                    nodes = {};

                    links.forEach(function(link) {
                        link.source = nodes[link.source] ||
                                (nodes[link.source] = { name: link.source, fixed: false });
                        link.target = nodes[link.target] ||
                                (nodes[link.target] = { name: link.target, fixed: false });
                        link.value = +link.value;
                    });

                    var force = d3.layout.force()
                            .nodes(d3.values(nodes))
                            .links(links)
                            .size([width, height])
                            .linkDistance(10)
                            .charge(-300)
                            .on("tick", tick)
                            .start();

//                    links.forEach(function(link) {
//                        link.source = nodes[link.source] ||
//                                (nodes[link.source] = { name: link.source, fixed: link.fixed });
//                        link.target = nodes[link.target] ||
//                                (nodes[link.target] = { name: link.target, fixed: link.fixed });
//                    });

                    var v = d3.scale.linear().range([0, 100]);

                    v.domain([0, d3.max(links, function(d) { return d.value; })]);

                    links.forEach(function(link) {
                        if (v(link.value) <= 25) {
                            link.type = "twofive";
                        } else if (v(link.value) <= 50 && v(link.value) > 25) {
                            link.type = "fivezero";
                        } else if (v(link.value) <= 75 && v(link.value) > 50) {
                            link.type = "sevenfive";
                        } else if (v(link.value) <= 100 && v(link.value) > 75) {
                            link.type = "onezerozero";
                        }
                    });

                    var svg = d3.select("body").append("svg")
                            .attr("width", width)
                            .attr("height", height);

                    svg.append("svg:defs").selectAll("marker")
                            .data(["end"])
                            .enter().append("svg:marker")
                            .attr("id", String)
                            .attr("viewBox", "0 -5 10 10")
                            .attr("refX", 15)
                            .attr("refY", -1.5)
                            .attr("markerWidth", 6)
                            .attr("markerHeight", 6)
                            .attr("orient", "auto")
                            .append("svg:path")
                            .attr("d", "M0,-5L10,0L0,5");

                    var path = svg.append("svg:g").selectAll("path")
                            .data(force.links())
                            .enter().append("svg:path")
                            .attr("class", function(d) { return "link " + d.type; })
                            .attr("marker-end", "url(#end)");

                    var node = svg.selectAll(".node")
                            .data(force.nodes())
                            .enter().append("g")
                            .attr("class", "node")
                            .on("click", click)
                            .on("dblclick", dblclick)
                            .call(force.drag);

                    node.append("circle")
                            .attr("r", 5)
                            .style("fill", function(d) { return color(d.name); })

                    node.append("text")
                            .attr("x", 12)
                            .attr("dy", ".35em")
                            .style("stroke", "none")
                            .style("stroke-width", ".5px")
                            .style("font", "10px sans-serif")
                            .text(function(d) { return d.name; });

                    function tick() {
                        path.attr("d", function(d) {
                            var dx = d.target.x - d.source.x,
                                dy = d.target.y - d.source.y,
                                dr = Math.sqrt(dx * dx + dy * dy);

                            return "M" +
                                    d.source.x + "," +
                                    d.source.y + "A" +
                                    dr + "," + dr + " 0 0,1 " +
                                    d.target.x + "," +
                                    d.target.y;
                        });

                        node.attr("transform", function(d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });
                    }

                    function click() {
                        d3.select(this).select("circle").transition()
                                .duration(500)
                                .attr("r", 16);

                        d3.select(this).select("text").transition()
                                .duration(500)
                                .attr("x", 22)
                                .style("stroke", "lightsteelblue")
                                .style("stroke-width", ".5px")
                                .style("font", "20px sans-serif");
                    }

                    function dblclick() {
                        d3.select(this).select("circle").transition()
                                .duration(500)
                                .attr("r", 5)

                        d3.select(this).select("text").transition()
                                .duration(500)
                                .attr("x", 12)
                                .style("stroke", "none")
                                .style("stroke-width", ".5px")
                                .style("font", "10px sans-serif");
                    }
                });
            }
        });
</script>

</html>
