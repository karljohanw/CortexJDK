<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contig viewer</title>
    <link rel="stylesheet" href="indiana.css"/>
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <style>
        .background {
            fill: #fff;
        }

        path.link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5px;
        }

        circle {
            fill: #ccc;
            stroke: #fff;
            stroke-width: 1.5px;
        }

        text {
            fill: #000;
            font: 10px sans-serif;
            pointer-events: none;
        }

    </style>
</head>

<body>

<article>
    <h1>Graph context</h1>

    <section>
        <select id="selectGraph"></select>
        <input type="search" id="search" placeholder="Enter name of contig" style="width: 500px">
        <span id="status">Ready.</span>
    </section>

    <section id="viewer"></section>

</article>

</body>

<script type="text/javascript">
function baseColor(base) {
    var color = "#cccccc";

    switch (base) {
        case 'A':
        case 'a':
            color = "#abd25e";
            break;
        case 'C':
        case 'c':
            color = "#249aa7";
            break;
        case 'G':
        case 'g':
            color = "#f8c830";
            break;
        case 'T':
        case 't':
            color = "#f1594a";
            break;
    }

    return color;
}

var displayType = "linear";

d3.json("graphlist", function (json) {
    d3.select("#selectGraph")
            .selectAll("option")
            .data(json.graphList)
            .enter()
            .append("option")
            .text(function (d) {
                return d;
            });

    d3.select("#selectGraph").on("change", showContig);
});

d3.select("#search").on("keyup", function () {
    if (d3.event.keyCode == 13) {
        showContig();
    }
});

function showContig() {
    var graphIndex = d3.select("#selectGraph").property("selectedIndex");
    var graphName = d3.select("#selectGraph").selectAll("option")[0][graphIndex].__data__;
    var contigName = encodeURIComponent(d3.select("#search").property("value"));

    d3.select("#status").text("Working...");

    if (graphName != null && contigName != null) {
        switch (displayType) {
            case "linear":
                showContigAsLinear(contigName, graphName);
                break;
            case "graph":
                showContigAsGraph(contigName, graphName);
                break;
        }
    }
}

function showContigAsLinear(contigName, graphName) {
    var width = innerWidth,
            height = innerHeight;

    d3.json("/search?contigName=" + contigName + "&graphName=" + graphName)
            .on("progress", function () {
                d3.select("#status").text("Displaying contig...");
            })
            .on("load", function (graph) {
                contig = graph.contig;

                d3.select("#viewer").selectAll("svg").remove();
                var svg = d3.select("#viewer").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .append("g")
                        .call(d3.behavior.zoom().on("zoom", zoom))
                        .append("g");

                svg.append("rect")
                        .attr("class", "overlay")
                        .attr("width", width * 10)
                        .attr("height", height);

                var edgeBases = graph.vertices.filter(function (d) {
                    return d.type != "CONTIG";
                });

                edgeBases.forEach(function (d) {
                    var xpos1 = (d.type == "OUT") ? 20.0 * d.pos : 20.0 * (d.pos - graph.kmerSize + 1);
                    var ypos1 = (height / 2) - 7;

                    var xpos2 = (d.type == "OUT") ? 20.0 * d.pos : 20.0 * (d.pos - graph.kmerSize + 1);
                    var ypos2 = (d.type == "OUT") ? (height / 2) - 60 : (height / 2) + 60;

                    var base = (d.type == "OUT") ? d.kmer.charAt(d.kmer.length - 1) : d.kmer.charAt(0);

                    svg.append("line")
                            .attr("x1", (d.type == "OUT") ? xpos1 - 20 : xpos1 + 20)
                            .attr("y1", ypos1)
                            .attr("x2", xpos2)
                            .attr("y2", (d.type == "OUT") ? ypos2 : ypos2 - 14)
                            .style("stroke", "#ccc")
                            .style("stroke-width", "3.0px")
                            .style("stroke-opacity", 0.9)

                    svg.append("text")
                            .attr("id", "edgebase")
                            .attr("class", "base" + base)
                            .attr("text-anchor", "middle")
                            .attr("x", xpos2)
                            .attr("y", ypos2)
                            .text(base);
                })

                var contigKmers = graph.vertices.filter(function(d) {
                    return d.type == "CONTIG";
                })

                var lastContigKmer = contigKmers[0];
                contigKmers.forEach(function(contigKmer) {
                    if (contigKmer.pos > lastContigKmer.pos) {
                        lastContigKmer = contigKmer;
                    }
                });

                svg.selectAll("text")
                        .data(contigKmers)
                        .enter()
                        .append("text")
                        .attr("id", function(d) { return d.kmer; })
                        .attr("class", function(d) { return "base" + d.kmer.charAt(0); })
                        .attr("text-anchor", "middle")
                        .attr("x", function(d) { return 20*(d.pos - graph.kmerSize + 1); })
                        .attr("y", height / 2)
                        .text(function(d) { return d.kmer.charAt(0); })
                        .on("mouseover", function(a) {
                            svg.append("rect")
                                    .attr("id", "kmercursor")
                                    .attr("width", 20.0 * graph.kmerSize)
                                    .attr("height", 3.0)
                                    .attr("x", parseInt(d3.select(this).attr("x")) - 10)
                                    .attr("y", (height / 2) + 2)
                        })
                        .on("mouseout", function(a) {
                            svg.selectAll("#kmercursor")
                                    .remove();

                        })
                        .on("click", function(a) {
                            var sk = d3.select(this).attr("id");

                            d3.json("/cr?graphName=" + graphName + "&sk=" + sk)
                                    .on("progress", function() {
                                        d3.select("#status").text("Fetching CortexRecord information for " + sk + "...");
                                    })
                                    .on("load", function(json) {
                                        d3.select("#status").text(sk + ": " + json.cr);
                                    })
                                    .get();
                        })

                for (var i = 1; i < lastContigKmer.kmer.length; i++) {
                    svg.append("text")
                            .attr("id", "lastKmer")
                            .attr("class", "base" + lastContigKmer.kmer.charAt(i))
                            .attr("text-anchor", "middle")
                            .attr("x", 20*(lastContigKmer.pos - graph.kmerSize + 1 + i))
                            .attr("y", height / 2)
                            .text(lastContigKmer.kmer.charAt(i))
                }

                d3.select("#status").text("Ready.");

                function zoom() {
                    svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                }
            })
            .get();
}

function showContigAsGraph(contigName, graphName) {
    var width = innerWidth,
            height = innerHeight;

    d3.json("/search?contigName=" + contigName + "&graphName=" + graphName, function (graph) {
        contig = graph.contig;
        links = graph.links;

        nodesWithLinks = {};
        graph.nodesWithLinks.forEach(function (a) {
            nodesWithLinks[a] = 1;
        });

        nodes = {};

        links.forEach(function (link) {
            link.source = nodes[link.source] || (nodes[link.source] = { name: link.source, base: link.source.charAt(0) });
            link.target = nodes[link.target] || (nodes[link.target] = { name: link.target, base: link.target.charAt(0) });
            link.value = +link.value;
        });

        var force = d3.layout.force()
                .nodes(d3.values(nodes))
                .links(links)
                .size([width, height])
                .linkDistance(1)
                .charge(-100)
                .on("tick", tick)
                .start();

        var v = d3.scale.linear().range([0, 100]);

        v.domain([0, d3.max(links, function (d) {
            return d.value;
        })]);

        d3.select("body").selectAll("svg").remove();

        var svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height);

        var path = svg.append("svg:g").selectAll("path")
                .data(force.links())
                .enter().append("svg:path")
                .attr("class", "link")
                .attr("id", function (d) {
                    return "link_" + d.source.name + "_" + d.target.name;
                })
                .style("stroke-width", function (d) {
                    return Math.log(d.value) + 1.0;
                })

        var node = svg.selectAll(".node")
                .data(force.nodes())
                .enter().append("g")
                .attr("id", function (d) {
                    return d.name;
                })
                .attr("class", "node")
                .on("dblclick", dblclick)
                .call(force.drag);

        node.append("circle")
                .attr("r", 5)
                .style("stroke", function (d) {
                    return (nodesWithLinks[d.name] == 1) ? baseColor(d.base) : "white";
                })
                .style("stroke-opacity", function (d) {
                    return (nodesWithLinks[d.name] == 1) ? 0.4 : 0.0;
                })
                .style("stroke-width", function (d) {
                    return (nodesWithLinks[d.name] == 1) ? "9.0px" : "1.5px";
                })
                .style("fill", function (d) {
                    return baseColor(d.base);
                })

        node.append("text")
                .attr("x", 12)
                .attr("dy", ".35em")
                .style("stroke", "none")
                .style("stroke-width", ".5px")
                .style("font", "10px sans-serif")
                .text(function (d) {
                    return d.base;
                });

        graph.kmersInLinks.forEach(function (a) {
            for (j = 0; j < a.length - 1; j++) {
                var source = a[j];
                var target = a[j + 1];
                var idFw = "#link_" + source + "_" + target;
                var idRc = "#link_" + target + "_" + source;

                d3.select(idFw)
                        .style("stroke-width", "3px")
                        .style("stroke", "blue")

                d3.select(idRc)
                        .style("stroke-width", "3px")
                        .style("stroke", "blue")
            }
        })

        function tick() {
            path.attr("d", function (d) {
                return "M " + d.source.x + " " + d.source.y +
                        "L " + d.target.x + " " + d.target.y;
            });

            node.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        }

        function dblclick() {
            var isSmall = d3.select(this).select("circle").attr("r") == 5;

            if (isSmall) {
                d3.select(this).select("circle").transition()
                        .duration(500)
                        .attr("r", 16);

                d3.select(this).select("text").transition()
                        .duration(500)
                        .attr("x", 22)
                        .style("stroke-width", ".5px")
                        .style("font", "20px sans-serif")
                        .text(function (d) {
                            return d.name;
                        })
            } else {
                d3.select(this).select("circle").transition()
                        .duration(500)
                        .attr("r", 5)

                d3.select(this).select("text").transition()
                        .duration(500)
                        .attr("x", 12)
                        .style("stroke-width", ".5px")
                        .style("font", "10px sans-serif")
                        .text(function (d) {
                            return d.base;
                        })
            }
        }
    });
}

</script>

</html>
