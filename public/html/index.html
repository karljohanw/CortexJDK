<html>
<head>
    <title>Test</title>
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="autocomplete.js" charset="utf-8"></script>
</head>

<body>
<h1>Contig context viewer</h1>

<div id="dataset">
</div>

<div id="contigSelection"></div>
<div id="contigDisplay"></div>

<script type="text/javascript">
    d3.json("dataset", function(json) {
        d3.select("#dataset").append("p").text("contigsFile: " + json.contigsFile);
        d3.select("#dataset").append("p").text("graphName: all").on("click", function() {
            k = 0;
            drawEdges(ci, "all");
        });

        json.graphs.map(function(o) {
            d3.select("#dataset")
                    .append("p")
                    .text("graphName: " + o.graphName + " (" + o.graphFile + ", " + o.kmerSize + ", " + o.numRecords + ", " + o.sampleName + ")")
                    .on("click", function() {
                        k = o.kmerSize;
                        drawEdges(ci, o.graphName);
                    });
        });
    });
</script>

<script type="text/javascript">
    var keys;
    var seq;
    var edges;
    var ci;
    var lastTranslate;
    var lastScale;
    var svg;
    var k = 0;

    var margin = {top: 40, right: 40, bottom: 40, left: 40},
            width = window.innerWidth - margin.left - margin.right,
            height = window.innerHeight - margin.top - margin.bottom;

    d3.csv("contigs.csv", function(csv) {
        keys=csv;
        start();
    });

    function drawEdges(d, currentGraph) {
        d3.json("edges?contigName=" + d.contigName + "&graphName=" + currentGraph, function(json) {
            edges = json;

            d3.selectAll(".outedge").remove();
            d3.selectAll(".outedgeline").remove();
            d3.selectAll(".inedge").remove();
            d3.selectAll(".inedgeline").remove();

            for (e in edges) {
                outKeys = d3.keys(edges[e].out);

                for (outKey in outKeys) {
                    svg.append("text")
                            .attr("class", "outedge")
                            .attr("text-anchor", "end")
                            .attr("x", e)
                            .attr("y", (height/2) - 3*(parseInt(outKey) + 1))
                            .attr("font-family", "monospace")
                            .attr("font-size", "1.5px")
                            .attr("fill", "black")
                            .text(edges[e].out[outKey]);

                    svg.append("line")
                            .attr("class", "outedgeline")
                            .attr("x1", e - 1 - 0.5)
                            .attr("y1", (height/2) - 1)
                            .attr("x2", e - 0.5)
                            .attr("y2", (height/2) - 3*(parseInt(outKey) + 1))
                            .attr("stroke-width", 0.1)
                            .attr("stroke", "black");
                }

                inKeys = d3.keys(edges[e].in);

                for (inKey in inKeys) {
                    svg.append("text")
                            .attr("class", "inedge")
                            .attr("text-anchor", "end")
                            .attr("x", e - 1)
                            .attr("y", (height/2) + 3*(parseInt(inKey) + 1))
                            .attr("font-family", "monospace")
                            .attr("font-size", "1.5px")
                            .attr("fill", "black")
                            .text(edges[e].in[inKey]);

                    svg.append("line")
                            .attr("class", "inedgeline")
                            .attr("x1", e - 0.5)
                            .attr("y1", (height/2))
                            .attr("x2", e - 1 - 0.5)
                            .attr("y2", (height/2) + 3*(parseInt(inKey) + 1) - 1)
                            .attr("stroke-width", 0.1)
                            .attr("stroke", "black");
                }
            }
        });
    }

    //Call back for when user selects an option
    function onSelect(d) {
        ci = d;
        k = 0;

        d3.json("contig?contigName=" + d.contigName, function(json) {
            console.log(json);
            seq=json;

            d3.select("#contigDisplay").select("svg").remove();

            var x = d3.scale.linear()
                      .domain([-json.seq.length / 2, json.seq.length / 2])
                      .range([0, width]);

            var y = d3.scale.linear()
                      .domain([-height / 2, height / 2])
                      .range([height, 0]);

            svg = d3.select("#contigDisplay").append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + (width - json.seq.length)/2 + "," + 0 + ")")
                        .call(d3.behavior.zoom().scaleExtent([1, 30]).on("zoom", zoom))
                        .append("g");

            svg.append("rect")
               .attr("width", width)
               .attr("height", height/2)
               .attr("fill", "white")

            var xPos = d3.range(0, json.seq.length, 1).map(function(n) {
                var base = json.seq.charAt(n);
                var color = "#cccccc";

                switch (base) {
                    case 'A':
                    case 'a':
                        color = "#00ff00";
                        break;
                    case 'C':
                    case 'c':
                        color = "#0000ff";
                        break;
                    case 'G':
                    case 'g':
                        color = "#ff8000";
                        break;
                    case 'T':
                    case 't':
                        color = "#ff0000";
                        break;
                }

                svg.append("text")
                   .attr("class", "x label")
                   .attr("text-anchor", "end")
                   .attr("x", n)
                   .attr("y", height/2)
                   .attr("font-family", "monospace")
                   .attr("font-size", "1.5px")
                   .attr("fill", color)
                   .text(base)
                   .on("mouseover", function(a) {
                            var ks = [k];
                            var th = [0.2];
                            var co = ["gray"];

                            if (k <= 1) {
                                ks = [31,  37,   41,   47,   51,   57];
                                th = [0.3, 0.25, 0.20, 0.15, 0.10, 0.05];
                                co = ["#16193B", "#35478C", "#4E7AC7", "#7FB2F0", "#ADD5F7", "#CBE3F7"];
                            }

                            for (i = ks.length; i >= 0; i--) {
                                ksa = ks[i];
                                tha = th[i];
                                coa = co[i];

                                svg.append("rect")
                                        .attr("class", "focus")
                                        .attr("width", ksa)
                                        .attr("height", 0.2)
                                        .attr("x", n - 1)
                                        .attr("y", (height / 2) + 0.5)
                                        .attr("fill", coa);
                            }
                        })
                   .on("mouseout", function(a) {
                            d3.selectAll(".focus").remove();
                        })
                   .on("click", function(a) {
                            if (k == 0) {
                                window.prompt("Contig: ", json.seq);
                            } else {
                                window.prompt("Kmer: ", json.seq.substring(n, n + k));
                            }
                        });
            });

            drawEdges(d, "all");

            function zoom() {
                svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                lastTranslate = d3.event.translate;
                lastScale = d3.event.scale;
            }
        });
    }

    //Setup and render the autocomplete
    function start() {
        var mc = autocomplete(document.getElementById('contigSelection'))
                .keys(keys)
                .dataField("contigName")
                .placeHolder("Contig name")
                .width(960)
                .height(500)
                .onSelected(onSelect)
                .render();
    }
</script>

</body>

</html>
