<!DOCTYPE html>
<html lang="en">
<head>
    <title>Graph viewer</title>
    <link rel="stylesheet" href="indiana.css" />
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="autocomplete.js" charset="utf-8"></script>
</head>

<body>

<div id="nav">
    <div id="kmerSelection"><input type="text" id="kmerBox" /><input type="checkbox" id="simplify"></div>
    <div id="info"></div>
    <div id="status"></div>
</div>

<div id="graphDisplay"></div>

<script type="text/javascript">
    d3.select("#kmerBox").on("keyup", function (d) {
        if (d3.event.keyCode == 13) {
            d3.select("#status").text("Loading...");

            d3.json("graph?kmer=" + this.value + "&simplify=" + d3.select("#simplify").property("checked"))
                .on("load", function(json) {
                    d3.selectAll("svg").remove();

                    drawGraph(json);
                })
                .get();
        }
    });

    function drawGraph(graph) {
        nodes = graph.nodes;
        links = graph.links;

        d3.selectAll("#kmerBox").property("value", graph.kmer);
        setDefaultStatus(graph);

        var w = window.innerWidth, h = window.innerHeight;

        d3.select("body")
                .on("dblclick.zoom", null)
                .on("keydown", function () {
//                    if (d3.behavior.zoom().on("zoom") == null) {
//                        parent.call(d3.behavior.zoom().on("zoom", zoom))
//                    } else {
//                        parent.call(d3.behavior.zoom().on("zoom", null))
//                    }

                    parent.call(d3.behavior.zoom().on("zoom", zoom))
                })
                .on("keyup", function () {
                    parent.call(d3.behavior.zoom().on("zoom", null))
                })

        var parent = d3.select("body").append("svg")
                .attr("width", w)
                .attr("height", h)
                .on("dblclick.zoom", null)
                .append("g")

        var svg = parent.append("g");

        svg.append("rect")
                .attr("class", "overlay")
                .attr("width", w)
                .attr("height", h)
                .on("dblclick.zoom", null)
                .on("click", function () {
                    setDefaultStatus(graph)
                });

        var defs = svg.append("defs");

        var markerClasses = ["Child", "Mother", "Father"];
        markerClasses.map(function(markerClass) {
            defs.append("marker")
                    .attr("id", "marker" + markerClass)
                    .attr("class", "marker" + markerClass)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 12)
                    .attr("refY", 0)
                    .attr("markerWidth", 3)
                    .attr("markerHeight", 3)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5");
        });

        var link = svg.selectAll("path");
        var node = svg.selectAll("circle");

        start();

        function start() {
            d3.selectAll("#link").remove();
            d3.selectAll("#node").remove();

            link = svg.append("g").selectAll("#link");
            node = svg.append("g").selectAll("#node");

            var force = d3.layout.force()
                    .nodes(nodes)
                    .links(links)
                    .size([w, h])
                    .linkDistance(20)
                    .on("tick", tick)
                    .charge(-200)
//                    .charge(function (d) {
//                        return d.isNovel ? -300 : -200;
//                    })

            force.start();
            for (var i = 0; i < nodes.length * nodes.length; i++) { force.tick(); }
            force.stop();

            link = link
                .data(force.links())
                .enter()
                .append("path")
                .attr("id", "link")
                .attr("stroke-width", function (d) {
                    return (d.highlight) ? "3.5px" : "1.5px";
                })
                .attr("class", function (d) {
                    switch (d.sample) {
                        case 0:
                            return "linkChild";
                            break;
                        case 1:
                            return "linkMother";
                            break;
                        case 2:
                            return "linkFather";
                            break;
                    }
                })
                .attr("marker-end", function (d) {
                    switch (d.sample) {
                        case 0:
                            return "url(#markerChild)";
                            break;
                        case 1:
                            return "url(#markerMother)";
                            break;
                        case 2:
                            return "url(#markerFather)";
                            break;
                    }
                });

            node = node
                .data(force.nodes())
                .enter().append("circle")
                .attr("id", "node")
                .attr("class", function (d) {
                    if (d.isNovel) { return "nodeNovel"; }
                    else if (d.branchRejected) { return "branchRejected"; }
                    else if (d.isRejected) {
                        return "nodeRejected";

                        d3.selectAll(this)
                                .attr("fill", "none")
                                .attr("rejectText")
                                .append("text")
                                .text("x");
                    }
                    else if (d.isPredecessor) { return "nodePredecessor"; }
                    else if (d.isSuccessor) { return "nodeSuccessor"; }
                    else { return "nodeNormal"; }
                })
                .attr("content", function(d) {
                    if (d.isRejected) { return "x"; }
                })
                .attr("r", function (d) {
                    return 3 + Math.sqrt(d.kmer.length / 47)
                })
                .attr("title", function (d) {
                    return d.kmer;
                })
                .on("mouseover", function (d) {
                    d3.json("crrecord?seq=" + d.kmer, function (result) {
                        d3.select("#status").text(result.recordText);
                    });

                    console.log(d.maternalLoci.length);
                    console.log(d.paternalLoci.length);

                    var tiptext = d.kmer;

                    if (d.maternalLoci.length == 1) { tiptext += " m:" + d.maternalLoci[0].sequence + ":" + d.maternalLoci[0].start + "-" + d.maternalLoci[0].end; }
                    if (d.paternalLoci.length == 1) { tiptext += " d:" + d.paternalLoci[0].sequence + ":" + d.paternalLoci[0].start + "-" + d.paternalLoci[0].end; }

                    //console.log(d);

                    svg.append("text")
                            .attr("id", "tip")
                            .attr("x", d.x + 10)
                            .attr("y", d.y - 10)
                            .attr("width", 100)
                            .attr("height", 50)
                            .text(tiptext);
                })
                .on("mouseout", function (d) {
                    svg.selectAll("#tip").remove();
                })
                .on("click", function (d) {
                    d3.select("#status").text(d.kmer + " (" + (d.kmer.length) + " bp)");
                })
                .on("dblclick", function (d) {
                    d3.json("explore?kmer=" + d.kmer + "&sindex=" + nodes.length, function (result) {
                        nodes = nodes.concat(result.nodes);
                        links = links.concat(result.links);

                        start();
                    });
                })
                .call(force.drag);

            force.start();

            /*
            d3.selectAll(".nodeRejected")
                    .attr("fill", "none")
                    .attr("rejectText")
                    .append("text")
                    .text("x");
            */
        }

        function setDefaultStatus(graph) {
            d3.select("#info").text("Vertices (full: " + graph.numVertices + ", simplified: " + graph.numVerticesSimplified + ").  Known (id: " + graph.knownVariant + ", type: " + graph.knownType + " ref: " + graph.knownRef + " alt: " + graph.knownAlt + ")");
            d3.select("#status").text("Ready.");
        }

        function tick() {
            link.attr("d", function(d) {
                switch (d.sample) {
                    case 1:
                        return "M" + d.source.x + "," + d.source.y + " " +
                               "C" + d.source.x + "," + (d.source.y - 10) + " " + d.target.x + "," + (d.target.y - 10) + " " +
                                d.target.x + "," + d.target.y;
                    case 2:
                        return "M" + d.source.x + "," + d.source.y + " " +
                               "C" + d.source.x + "," + (d.source.y + 10) + " " + d.target.x + "," + (d.target.y + 10) + " " +
                                d.target.x + "," + d.target.y;
                    default:
                        return "M" + d.source.x + "," + d.source.y + " " +
                               "L" + d.target.x + "," + d.target.y;
                }
            });

            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        }

        function zoom() {
            svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }
    }
</script>

</body>

</html>
