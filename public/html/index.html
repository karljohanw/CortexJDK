<!DOCTYPE html>
<html lang="en">
<head>
    <title>Graph viewer</title>
    <link rel="stylesheet" href="indiana.css" />
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="autocomplete.js" charset="utf-8"></script>
</head>

<body>

<div id="nav">
    <div id="kmerSelection"><input type="text" id="kmerBox" /><input type="checkbox" id="simplify" checked></div>
    <div id="status"></div>
</div>

<div id="graphDisplay"></div>

<script type="text/javascript">
    d3.select("#kmerBox").on("keyup", function (d) {
        if (d3.event.keyCode == 13) {
            d3.select("#status").text("Loading...");

            d3.json("graph?kmer=" + this.value + "&simplify=" + d3.select("#simplify").property("checked"))
                .on("load", function(json) {
                    d3.selectAll("svg").remove();

                    drawGraph(json);
                })
                .get();
        }
    });

    function drawGraph(graph) {
        nodes = graph.nodes;
        links = graph.links;

        var w = window.innerWidth, h = window.innerHeight;

        var force = d3.layout.force()
                .nodes(d3.values(nodes))
                .links(links)
                .size([w, h])
                .linkDistance(20)
                .charge(function (d) {
                    return d.isNovel ? -300 : -200;
                })

        force.start();
        for (var i = 0; i < nodes.length * nodes.length; i++) force.tick();
        force.stop();

        force
                .on("tick", tick)
                .start();

        var svg = d3.select("body").append("svg")
                .attr("width", w)
                .attr("height", h)
                .append("g")
                .call(d3.behavior.zoom().on("zoom", zoom))
                .on("dblclick.zoom", null)
                .append("g");

        svg.append("rect")
                .attr("class", "overlay")
                .attr("width", w)
                .attr("height", h)
                .on("click", function () {
                    setDefaultStatus(graph)
                });

        var markerClasses = ["Child", "Mother", "Father"];
        markerClasses.map(function(markerClass) {
            svg.append("defs").append("marker")
                    .attr("id", "marker" + markerClass)
                    .attr("class", "marker" + markerClass)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 15)
                    .attr("refY", 0)
                    .attr("markerWidth", 3)
                    .attr("markerHeight", 3)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5");
        });

        var path = svg.append("g").selectAll("path")
                .data(force.links())
                .enter()
                .append("path")
                .attr("id", "link")
                .attr("class", function(d) {
                    switch (d.sample) {
                        case 0: return "linkChild"; break;
                        case 1: return "linkMother"; break;
                        case 2: return "linkFather"; break;
                    }
                })
                .attr("marker-end", function(d) {
                    switch (d.sample) {
                        case 0: return "url(#markerChild)"; break;
                        case 1: return "url(#markerMother)"; break;
                        case 2: return "url(#markerFather)"; break;
                    }
                })

        var circle = svg.append("g").selectAll("circle")
                .data(force.nodes())
                .enter().append("circle")
                .attr("id", "node")
                .attr("class", function(d) {
                    return (d.isNovel ? "nodeNovel" : "nodeNormal")
                })
                .attr("stroke", function(d) {
                    if (d.isPredecessor) {
                        return "#00ff00";
                    } else if (d.isSuccessor) {
                        return "#0000ff";
                    }
                })
                .attr("r", function(d) {
                    return 3 + Math.sqrt(d.kmer.length/47)
                })
                .attr("title", function(d) { return d.kmer; })
                .on("mouseover", function(d) {
                    d3.json("crrecord?seq=" + d.kmer, function(result) {
                        d3.select("#status").text(result.recordText);
                    });

                    svg.append("text")
                        .attr("id", "tip")
                        .attr("x", d.x + 10)
                        .attr("y", d.y - 10)
                        .attr("width", 100)
                        .attr("height", 50)
                        .text(d.kmer)
                })
                .on("mouseout", function(d) {
                    svg.selectAll("#tip").remove();
                })
                .on("click", function(d) {
                    d3.select("#status").text(d.kmer + " (" + (d.kmer.length) + " bp)");
                })
                .on("dblclick", function(d) {
                    d3.json("crrecord?seq=" + d.kmer, function(result) {
                        d3.select("#status").text(result.recordText);
                    });
                })
                .call(force.drag);

        d3.selectAll("#kmerBox").property("value", graph.kmer);
        setDefaultStatus(graph);

        function setDefaultStatus(graph) {
            d3.select("#status").text("Vertices (full: " + graph.numVertices + ", simplified: " + graph.numVerticesSimplified + ")");
        }

        function tick() {
            path.attr("d", function(d) {
                switch (d.sample) {
                    case 1:
                        return "M" + d.source.x + "," + d.source.y + " " +
                               "C" + d.source.x + "," + (d.source.y - 10) + " " + d.target.x + "," + (d.target.y - 10) + " " +
                                d.target.x + "," + d.target.y;
                    case 2:
                        return "M" + d.source.x + "," + d.source.y + " " +
                               "C" + d.source.x + "," + (d.source.y + 10) + " " + d.target.x + "," + (d.target.y + 10) + " " +
                                d.target.x + "," + d.target.y;
                    default:
                        return "M" + d.source.x + "," + d.source.y + " " +
                               "L" + d.target.x + "," + d.target.y;
                }
            });

            circle.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        }

        function zoom() {
            svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }
    }
</script>

</body>

</html>
